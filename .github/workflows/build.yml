name: Build EA DLC Unlocker v2

on:
  push: 
    branches: [ main, master, develop ]
    paths:
      - 'src/**'
      - 'CMakeLists.txt'
      - '.github/workflows/build.yml'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env: 
  DETOURS_VERSION: v4.0.1
  BUILD_DIRECTORY: build

jobs: 
  build:
    name: Build ${{ matrix.platform }}-${{ matrix.configuration }}
    runs-on: windows-latest

    strategy:
      fail-fast: false
      matrix: 
        platform: [x64]
        configuration: [Release, Debug]

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name:  Setup MSVC Compiler
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64

    - name: Download Microsoft Detours Library
      run: |
        Write-Host "Downloading Detours v4.0.1..." -ForegroundColor Green
        Invoke-WebRequest `
          -Uri "https://github.com/microsoft/Detours/archive/refs/tags/${{ env.DETOURS_VERSION }}.zip" `
          -OutFile "detours.zip" `
          -ErrorAction Stop

        Write-Host "Extracting Detours..." -ForegroundColor Green
        Expand-Archive -Path "detours.zip" -DestinationPath "." -ErrorAction Stop
        Rename-Item -Path "Detours-4.0.1" -NewName "Detours" -ErrorAction Stop
        Remove-Item -Path "detours.zip" -ErrorAction Stop

        Write-Host "✓ Detours ready" -ForegroundColor Green
      shell: powershell

    - name: Build Detours Library
      run: |
        cd Detours\src
        Write-Host "Building Detours..." -ForegroundColor Green
        nmake
        if ($LASTEXITCODE -ne 0) {
          Write-Host "✗ Detours build failed" -ForegroundColor Red
          exit 1
        }
        Write-Host "✓ Detours built successfully" -ForegroundColor Green
      shell: powershell

    - name: Create Build Directory
      run: |
        mkdir -p ${{ env.BUILD_DIRECTORY }}
      shell: bash

    - name: Compile version.dll
      run: |
        echo "Building version.dll (${{ matrix.configuration }})..."
        cd src

        set DETOURS_INCLUDE=..\Detours\include
        set DETOURS_LIB=..\Detours\lib.${{ matrix.platform }}
        set OUT_DIR=..\${{ env.BUILD_DIRECTORY }}

        cl.exe /LD version.cpp /DEF:version.def /EHsc ^
          /I"%DETOURS_INCLUDE%" ^
          /Fo"%OUT_DIR%\" ^
          /Fe"%OUT_DIR%\version.dll" ^
          /W4 ^
          /WX: OFF ^
          /std:c++17 ^
          /O2 ^
          /DUNICODE ^
          /D_UNICODE ^
          /link "%DETOURS_LIB%\detours.lib" kernel32.lib user32.lib shell32.lib wininet.lib

        if errorlevel 1 (
          echo ✗ Build failed! 
          exit /b 1
        )

        echo ✓ Build successful! 
      shell: cmd

    - name:  Verify DLL Existence
      run: |
        if (Test-Path "${{ env.BUILD_DIRECTORY }}\version.dll") {
          $fileSize = (Get-Item "${{ env.BUILD_DIRECTORY }}\version.dll").Length
          Write-Host "✓ DLL created successfully" -ForegroundColor Green
          Write-Host "  File: ${{ env.BUILD_DIRECTORY }}\version.dll" -ForegroundColor Green
          Write-Host "  Size: $([Math]::Round($fileSize / 1KB, 2)) KB" -ForegroundColor Green
        } else {
          Write-Host "✗ DLL not found!" -ForegroundColor Red
          exit 1
        }
      shell: powershell

    - name: Generate Build Report
      if: always()
      run: |
        $reportPath = "${{ env.BUILD_DIRECTORY }}\build-report.txt"

        "Build Report for EA DLC Unlocker v2" > $reportPath
        "========================================" >> $reportPath
        "Date: $(Get-Date)" >> $reportPath
        "Configuration: ${{ matrix.configuration }}" >> $reportPath
        "Platform: ${{ matrix.platform }}" >> $reportPath
        "Status: ${{ job.status }}" >> $reportPath
        "" >> $reportPath

        if (Test-Path "${{ env.BUILD_DIRECTORY }}\version.dll") {
          $fileSize = (Get-Item "${{ env.BUILD_DIRECTORY }}\version.dll").Length
          "✓ DLL Build: SUCCESS" >> $reportPath
          "  Size: $([Math]::Round($fileSize / 1KB, 2)) KB" >> $reportPath
        } else {
          "✗ DLL Build: FAILED" >> $reportPath
        }
      shell: powershell

    - name: Upload Build Artifacts
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name:  version-dll-${{ matrix.platform }}-${{ matrix.configuration }}
        path: |
          ${{ env.BUILD_DIRECTORY }}/version.dll
          ${{ env. BUILD_DIRECTORY }}/version.lib
          ${{ env.BUILD_DIRECTORY }}/version.exp
          ${{ env.BUILD_DIRECTORY }}/build-report.txt
        retention-days: 30
        compression-level: 6

    - name: Create Release on Tag
      if: startsWith(github.ref, 'refs/tags/v') && success() && matrix.configuration == 'Release'
      uses: softprops/action-gh-release@v2
      with:
        files: ${{ env.BUILD_DIRECTORY }}/version.dll
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  analysis:
    name: Code Analysis
    runs-on: windows-latest
    if: always()

    steps:
    - name:  Checkout Repository
      uses: actions/checkout@v4

    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch:  x64

    - name: Run Clang Static Analyzer
      continue-on-error: true
      run: |
        cd src
        clang --analyze version.cpp -I../Detours/include || echo "Note: Clang analyzer may not be available"
      shell: bash

  quality-gates:
    name: Quality Gates
    runs-on: ubuntu-latest
    needs: build
    if: always()

    steps:
    - name: Check Build Status
      run: |
        if [ "${{ needs.build.result }}" != "success" ]; then
          echo "❌ Build failed.  Check logs above."
          exit 1
        fi
        echo "✅ Build quality gates passed"
